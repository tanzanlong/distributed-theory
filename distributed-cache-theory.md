# 分布式系统理论

 ## 什么是原子提交协议？（https://en.wikipedia.org/wiki/Atomic_commit）
  
将一系列的改变作为一个操作，这些变更落实之后，就认为这个操作已经成功，在这些变更提交成功之前，有某些变更失败了，之前成功的那些变更都会回退。确保系统一直处于一致状态。原子操作另外一个关键特性是隔离性。隔离确保一次只处理一个原子提交。原子提交最常见的用途是在数据库系统和版本控制系统中。
数据库系统中的原子提交实现了ACID的两个关键属性，原子性和一致性。只有原子提交中的每个更改都一致才能实现一致性。
原子提交对于数据库中的多步操作至关重要。由于数据库所在物理磁盘的现代硬件设计，原子提交不能存在。可以在磁盘上写入的最小区域称为扇区。单个数据库条目可能跨越多个不同的扇区。一次只能写入一个部分。这个写作限制是为什么真正的原子提交是不可能的。内存中的数据库条目已被修改后，它们排队等待写入磁盘。这意味着在这个例子中发现的问题再次出现。对这个问题的任何算法解决方案仍然会遇到两个将军的问题。的两阶段提交协议和三阶段提交协议试图解决这个问题以及与原子提交相关的一些其他问题。


 ## 两阶段提交（https://en.wikipedia.org/wiki/Two-phase_commit_protocol）
 两阶段提交是一种原子提交协议。
 
  
# 分布式系统设计策略
## 心跳检测
如何检测一个节点出现了故障乃至无法工作了？具体场景比如主备之间（zk切换）的切换，或者是一个管理服务器来管理具体的工作节点（redis sential机制）。这些都需要“判定某节点无法工作”。传统方法就是心跳检测。
  当服务器没有接收到某节点的心跳时，服务器会认为节点失联，但并不确定节点是否故障。有可能是节点繁忙导致超时，也可以是链路问题出现故障或闪断。所以收到心跳可以证明节点正常，但是没有收到却不能确定该节点已宣告“死亡”。
    解决方案：
    1.周期检测心跳机制；服务器每间隔t秒向集群发起检测请求，设定超时时间，如果超过超时时间，则判定为“死亡”。这里的超时时间可以统计实际检测节点的返回时间。包括得到一定周期内的最长时间。可以根据历史统计的分布计算“死亡”概率。同时可以对该节点发起有限次数的重试。心跳检测本身也是有效资源和成本之间的一种权衡，如果迟迟不能判断节点状态，会影响业务逻辑的处理，通过周期检测心跳，累计实效检测可以帮助判断状态。如果判定为“死亡”就将节点踢出集群。
    
   2.累计失效检测机制；
   
   ## 高可用设计
   系统高可用性的常用设计模式包括三种：主备（master-slave），互备（active-active）和集群（cluster）模式。
    ###主备模式
       即当主机宕机时，备机接管主机的一切工作，待主机恢复正常后，按使用者的设定以自动（热备）或手动（冷备）方式将服务切换到主机上运行。这种模式在数据库中比较常见，并且比较成熟。mysql就具备软件套装，但存在master到slave的数据延迟风险，尤其是跨地域复制。
      ###互备模式
      两台主机同时运行各自的服务工作，相互检测情况。在数据库高可用部分，常见的互备是MM模式。存在多个master，每个master具有read-write能力，需要根据时间戳或业务逻辑合并版本。
     ###集群模式
     集群模式是指多个节点在运行，同时可以通过主控节点分担服务请求，比如zk。集群模式要特别解决主控节点本身的高可用问题。

 ## 容错性
   容错即是系统对错误包容的能力，这里的错误确切说是容故障，而非错误。mysql的容错是通过主备切换来完成的。
   容错的处理是保障分布式环境下相应系统的高可用或者健壮，一个典型的案例就是对缓存实效雪崩问题的解决方案。
     假设一个业务，用户查询不到数据，用户可以间隔一定时间后重试，那么可以这样设计缓存容错方案。
  我们在项目中使用缓存通常先检查缓存中是否存在，如果存在直接返回缓存内容，如果不存在直接查询数据库然后再缓存查询结果返回。这个时候如果我们查询的某一个数据在缓存中一直不存在，就会造成每次请求都查询DB，这样缓存就失去意义，流量大时，DB就挂掉了。我们可以通过下面的方法来解决。我们可以将这个不存在的key预先设定一个值。比如 key=“&&”。在返回这个值得时候，我们的应用就可以认为这是不存在的key，那我们的应用就可以决定是否继续等待继续访问，还是放弃这次操作。如果继续等待访问，过一个时间轮询点后，再次请求这个key，如果取到值不再是&&，则可以认为这个时候key有值了，从而避免透传到数据库。
   ## 负载均衡
  硬件负载均衡有F5，软件有LVS，HAProxy，Nginx等。
   nginx有以下几种策略，轮询，最少连接数，ip地址hash，基于权重的负载均衡。



# 分布式系统设计实践
  ## 全局id生成

 


